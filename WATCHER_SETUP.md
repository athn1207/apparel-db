# フォルダ監視のセットアップ（Google Drive 連携）

メルカリのスクショを Google Drive の特定フォルダに置くだけで、OCR が自動実行され **data/data.json** に商品が追加される仕組みです。すべて無料・Windows 対応です。

---

## 完成形のファイル構成

```
apparel-db/
├── watch_config.json          # 監視フォルダなどの設定（要編集）
├── run_watcher.bat           # 監視の起動用
├── WATCHER_SETUP.md          # このファイル
├── data/
│   └── data.json             # 自動でここに追記される
├── images/                   # 処理した画像がここにコピーされる
├── processed/                # 処理済み画像がここへ移動（自動作成）
├── failed/                   # エラーだった画像がここへ移動（自動作成）
├── scripts/
│   ├── watch_drive.py        # 監視スクリプト（watchdog）
│   ├── mercari_ocr.py        # OCR 実行
│   └── ...
├── screenshot_config.json
└── requirements-screenshots.txt  # watchdog を追加済み
```

---

## 1. 初回セットアップ

### 1-1. 監視したいフォルダを用意する

- Google Drive 内にフォルダを 1 つ作る（例: **MercariScreenshots**）
- ここにメルカリのスクショ（.png / .jpg）を保存すると自動処理されます

### 1-2. watch_config.json を編集する

プロジェクト直下の **watch_config.json** を開き、`watch_folder` をあなたの Google Drive のフォルダパスに変更してください。

```json
{
  "watch_folder": "C:\\Users\\akiko\\Google Drive\\My Drive\\MercariScreenshots",
  "data_json": "data/data.json",
  "images_dir": "images",
  "processed_dir": "processed",
  "failed_dir": "failed"
}
```

- **watch_folder**: 監視するフォルダの**絶対パス**（バックスラッシュは `\\` で 2 つ書く）
- パスの確認方法: エクスプローラーでそのフォルダを開き、アドレスバーをクリックしてパスをコピー

### 1-3. 依存関係のインストール

```powershell
cd "c:\Users\akiko\OneDrive\デスクトップ\apparel-db"
pip install -r requirements-screenshots.txt
```

（watchdog が入っていれば監視が動きます。Tesseract は従来どおり PC にインストールが必要です。）

### 1-4. Google Drive の同期確認と監視フォルダの設定

監視フォルダ（例: **G:\マイドライブ\MercariScreenshots**）が「クラウドだけ」の状態だと、画像を置いても PC 上にすぐ反映されず、監視が検知しないことがあります。次で**同期されているか確認**し、**監視フォルダを「オフラインで使用可能」**にすると安定します。

#### 同期状態の確認方法

| 確認場所 | 見方 |
|----------|------|
| **タスクバーの Google Drive アイコン** | 右下（タスクバー）の **Google Drive のアイコン**をクリック。「同期中」「同期済み」などの表示や、エラーがあればここに出ます。 |
| **フォルダ・ファイルのアイコン** | エクスプローラーで **G:\マイドライブ** を開いたとき、フォルダやファイルに次のようなマークが出ることがあります。<br>・**✓（チェック）** … 同期完了・ローカルにあり<br>・**↻（矢印）** … 同期中<br>・**☁（雲）** … クラウドのみ（まだ PC にダウンロードされていない）<br>・**×** … 同期エラー |
| **監視フォルダを開けるか** | **G:\マイドライブ\MercariScreenshots** をエクスプローラーで開き、中に画像を 1 枚入れて、数秒後にそのファイルが一覧に表示されるか確認。表示されない・開けない場合は同期やパスの問題の可能性があります。 |

#### MercariScreenshots フォルダだけ「常に同期」にする（推奨）

マイドライブが全部 ☁（雲マーク）＝ストリーミングのままでも、**MercariScreenshots フォルダだけ**「オフラインで使用可能」にすると、このフォルダ内だけ常に PC に同期され、監視が確実に動きます。

**手順（エクスプローラーから）**

1. エクスプローラーで **G:\マイドライブ** を開く  
2. **MercariScreenshots** フォルダを **右クリック**  
3. メニューから次のどちらかを選ぶ  
   - **「Google ドライブ」** という項目があれば、その中から **「オフラインで使用可能にする」** をクリック  
   - または、一覧に直接 **「オフラインで使用可能」** または **「Available offline」** があれば、それをクリック（チェックが付く）  
4. 設定後、**MercariScreenshots** フォルダに **✓（チェックマーク）** や「同期済み」のマークが付くまで待つ（中身のファイル数によっては数分かかることがあります）  
5. このフォルダに画像を入れると、常に PC に保存され、監視スクリプトが検知しやすくなります  

**「オフラインで使用可能」が見つからない場合**

- 右クリックメニューの **「その他のオプションを表示」** や、メニューの下の方にある **「Google ドライブ」** のサブメニューを開いて探す  
- Google Drive for Desktop のバージョンによっては、**「オフラインでアクセス可能」** や **「このデバイスで使用可能」** という表記の場合もあります  
- それでも出ない場合: タスクバーの **Google Drive アイコン** → **設定（歯車）** → **設定** から、同期方式の説明を確認し、アプリを最新に更新してから再度右クリックメニューを確認する

---

## 2. 監視の起動方法

### 手動で起動する

- **run_watcher.bat** をダブルクリックする  
- 黒いコンソールが開き「監視を開始しました」と出れば OK  
- 終了するときは、そのウィンドウを閉じるか **Ctrl+C**

### 動作確認（監視が正しく動いているか試す）

**前提:** まず **run_watcher.bat** をダブルクリックし、黒い画面に「監視を開始しました」と出ている状態にしておく。

| ステップ | やること | 確認ポイント |
|----------|----------|----------------|
| **①** | **監視フォルダ**（watch_config.json で指定したフォルダ）を開く。<br>例: エクスプローラーで **G:\マイドライブ\MercariScreenshots** を開く | このフォルダが「監視対象」です。ここに画像を入れると自動処理されます。 |
| **②** | メルカリのスクショなど、**.png または .jpg の画像を 1 枚**、そのフォルダに**コピー＆ペースト**または**保存**する。 | 新規に「ファイルが追加された」状態にすることが大事です。 |
| **③** | **5〜10 秒ほど待つ**。黒いコンソール画面を見る。 | 「[Raw OCR] …」「追加しました: id=product-XXX …」のようなログが出れば成功です。 |
| **④** | 次を確認する。 | すべて満たされていれば動作確認完了です。 |

- **data/data.json** を開く → 一番下に、今追加した商品（id: product-XXX）が 1 件増えている  
- **images/** フォルダを開く → 今コピーした画像が **product-XXX_1.png** のような名前で入っている  
- **監視フォルダ（MercariScreenshots）** を開く → さっき入れた画像が**なくなっている**（処理済みへ移動したため）  
- **processed/** フォルダを開く → さっき入れた画像が**ここに移動している**

---

## 3. PC 起動後に自動で監視を開始する（Windows スタートアップ）

### 方法A: スタートアップフォルダに bat のショートカットを置く（おすすめ）

1. キーボードで **Win + R** を押し、「ファイル名を指定して実行」の小さな窓を開く  
2. その窓に **`shell:startup`** と入力して **Enter**  
   - ※ **PowerShell やコマンドプロンプトには入力しないでください。** Win+R で出る「実行」の窓に入力します。  
   - スタートアップフォルダがエクスプローラーで開きます
3. 開いたスタートアップフォルダに、**run_watcher.bat のショートカット**を入れる。次のどちらかでできます。  

   **やり方 A（ショートカットを作ってから持っていく）**  
   - プロジェクトフォルダ（apparel-db）を開き、**run_watcher.bat** を**右クリック**  
   - **「ショートカットの作成」** を選ぶ → 同じフォルダに「run_watcher.bat - ショートカット」ができる  
   - そのショートカットを**切り取り（Ctrl+X）**し、スタートアップフォルダを開いて**貼り付け（Ctrl+V）**  

   **やり方 B（スタートアップフォルダでショートカットを新規作成）**  
   - スタートアップフォルダ内で**右クリック** → **新規作成** → **ショートカット**  
   - 「項目の場所を入力してください」で **参照** をクリックし、プロジェクト内の **run_watcher.bat** を選ぶ → 次へ  
   - 名前はそのまま「run_watcher.bat」で OK → 完了  

4. **（重要）ショートカットの「作業フォルダ」を設定する**  
   - スタートアップフォルダに入れた **run_watcher.bat のショートカット** を**右クリック** → **プロパティ**  
   - **「作業フォルダ」**（または「開始する場所」）の欄に、プロジェクトフォルダのパスを入力する  
     - 例: `c:\Users\akiko\OneDrive\デスクトップ\apparel-db`  
   - **OK** で閉じる  

5. 次回から PC ログイン後に監視が自動で開始されます  
6. コンソールが毎回表示されるのが気になる場合は、下の「方法B」で非表示にできます  

**※ 自動で開始されない場合** → 下の「自動で開始されないときの確認」を参照

### 方法B: タスクスケジューラでログオン時に非表示で起動する

1. **Win** キーを押し、「タスク スケジューラ」で検索して開く  
2. **「基本タスクの作成」** を選ぶ  
3. 名前: 「Mercari OCR 監視」など → 次へ  
4. トリガー: **「コンピューターの起動時」** または **「ユーザーがログオンしたとき」** → 次へ  
5. 操作: **「プログラムの開始」** → 次へ  
6. プログラム: **pythonw** のフルパス（例: `C:\Users\akiko\AppData\Local\Programs\Python\Python311\pythonw.exe`）  
   - または **run_watcher.bat** を指定する場合は、プログラム: `cmd.exe`、引数: `/c "c:\Users\akiko\OneDrive\デスクトップ\apparel-db\run_watcher.bat"` のようにする  
7. 「開始」の欄に、プロジェクトフォルダのパスを指定（例: `c:\Users\akiko\OneDrive\デスクトップ\apparel-db`）  
8. 非表示で動かす場合: タスク作成後、そのタスクをダブルクリック → **「全般」** タブで **「最上位の特権で実行する」の下にある「ユーザーがログオンしているときのみ実行する」を選び、さらに **「設定」** タブで **「タスクを実行するときに実行するユーザーを指定する」** の下で **「ユーザーがログオンしている場合にのみ実行」** を選ぶ。  
   - ウィンドウを出さないようにするには、プログラムに **pythonw.exe** を使い、引数で `scripts\watch_drive.py` を指定する（作業フォルダをプロジェクトに設定）。

※ 方法B で pythonw を使う場合の例  
- プログラム: `C:\…\Python\Python311\pythonw.exe`  
- 引数: `scripts\watch_drive.py`  
- 開始: `c:\Users\akiko\OneDrive\デスクトップ\apparel-db`

---

## 4. 自動で開始されないときの確認

スタートアップにショートカットを入れても、ログイン後に監視が始まらない場合は、次を順に試してください。

| 確認すること | やり方 |
|--------------|--------|
| **① ショートカットの「作業フォルダ」** | スタートアップフォルダ内の **run_watcher.bat のショートカット** を右クリック → **プロパティ** → **「作業フォルダ」**（開始する場所）に **`c:\Users\akiko\OneDrive\デスクトップ\apparel-db`** のようにプロジェクトのパスを入れ、OK。 |
| **② 手動でショートカットを実行** | スタートアップに入れた **ショートカットをダブルクリック** して、黒い画面が出て「監視を開始しました」と表示されるか確認。出ない場合は、プロジェクトフォルダ内の **run_watcher.bat** を直接ダブルクリックして動くか確認。 |
| **③ ログオン直後は Python がまだ使えないことがある** | スタートアップは「ログオン直後」に実行されるため、Python の PATH がまだ読まれていない場合があります。**タスクスケジューラ**（下の方法B）で「ログオン時」＋**「1〜2分遅延」** にすると動くことがあります。 |
| **④ タスクスケジューラで確実に動かす** | **方法B（タスクスケジューラ）** を使う。トリガーで「ログオン時」を選んだあと、**「遅延時間を設定する」** に 1 分や 2 分を指定すると、ログオン後に少し待ってから監視が始まり、自動で開始されやすくなります。 |

---

## 5. 仕様の整理

| 項目 | 内容 |
|------|------|
| 監視対象 | watch_config.json の **watch_folder** のみ（新規ファイルのみ） |
| 対象拡張子 | .png / .jpg / .jpeg |
| 処理内容 | mercari_ocr.py で OCR → **data/data.json** に 1 件追加 → 画像を **images/** にコピー |
| 処理後 | 元画像は **processed/** へ移動 |
| エラー時 | 処理に失敗した画像は **failed/** へ移動（data.json は更新されない） |

---

## 6. トラブルシューティング

- **「オフラインで同期しているのに、画像を入れても自動で data.json に追加されない」**  
  1. **監視が動いているか** … 黒いコンソール（「Mercari OCR フォルダ監視」）が**起動したまま**になっているか確認。閉じていると監視していません。タスクバーやタスクマネージャーで **python** が動いているかも確認。  
  2. **スタートアップで起動しているか** … ログオン後に監視を自動で始めたい場合は、**「4. 自動で開始されないときの確認」** のとおり、ショートカットの「作業フォルダ」設定やタスクスケジューラの遅延を試す。  
  3. **watch_folder のパス** … watch_config.json の **watch_folder** が、実際のフォルダ（例: `G:\マイドライブ\MercariScreenshots`）と**完全に一致**しているか確認。  
  4. **スクリプトの改善** … Google Drive では「新規ファイル」が **「変更」(modified)** イベントで検知されることがあります。監視スクリプトは **作成・変更の両方** を検知するようにしてあり、ファイル出現後 2 秒待ってから処理するようにしています。最新の watch_drive.py に更新されていれば、同期フォルダでも検知されやすくなっています。  
- **「監視フォルダが存在しません」**  
  1. **実際のパスを確認する** … エクスプローラーで **PC**（または「このPC」）を開き、**Google Drive** が表示されているか確認。表示されているドライブ（例: G: や H:）をダブルクリックして開く。  
  2. 中にある **「マイドライブ」** または **「My Drive」** を開く。  
  3. **MercariScreenshots** フォルダがなければ**新規作成**する。そのフォルダを開いた状態で、**アドレスバー（上部のパスが表示されている欄）をクリック**するとパスが選択されるので、**Ctrl+C** でコピー。  
  4. **watch_config.json** の **watch_folder** に、そのパスを貼り付ける。このとき、**バックスラッシュ \ はすべて \\ に書き換える**（例: `G:\My Drive\MercariScreenshots` → `"G:\\My Drive\\MercariScreenshots"`）。  
  - よくあるパス例: `G:\My Drive\MercariScreenshots`（英語表示）、`G:\マイドライブ\MercariScreenshots`（日本語）。ドライブレター（G:）は PC によって異なることがあるので、エクスプローラーで確認した値を使う。  
  - Google Drive が「ストリーミング」の場合は、そのフォルダを「オフラインで使用可能」にしておく。
- **「watchdog がインストールされていません」**  
  - `pip install watchdog` または `pip install -r requirements-screenshots.txt`
- **OCR が動かない / 商品名がおかしい**  
  - Tesseract がインストールされているか、screenshot_config.json や mercari_ocr の領域設定を確認（従来の手動実行と同じ条件です）
